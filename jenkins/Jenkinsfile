pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "roshaan1103/kaniko-test"
        DOCKER_TAG = "${BUILD_NUMBER}"
        NAMESPACE = "jenkins"
        JOB_NAME = "kaniko-${BUILD_NUMBER}"
    }

    stages {

        stage('Build & Push Image with Kaniko Job') {
            steps {
                sh """
                echo "Creating Kaniko Job..."

                kubectl create job ${JOB_NAME} \
                  --namespace=${NAMESPACE} \
                  --image=gcr.io/kaniko-project/executor:latest \
                  -- /kaniko/executor \
                  --dockerfile=jenkins/Dockerfile \
                  --context=git://github.com/roshaan1103/kaniko-test.git \
                  --destination=${DOCKER_IMAGE}:${DOCKER_TAG}

                echo "Waiting for Kaniko job to complete..."
                kubectl wait --for=condition=complete job/${JOB_NAME} \
                  -n ${NAMESPACE} --timeout=600s

                echo "Printing Kaniko logs..."
                kubectl logs job/${JOB_NAME} -n ${NAMESPACE}
                """
            }
        }

        stage('Deploy to Kubernetes with Helm') {
            steps {
                sh """
                echo "Deploying application with Helm..."

                helm upgrade --install kaniko-app ./kaniko-app \
                  --namespace ${NAMESPACE} \
                  --set image.tag=${DOCKER_TAG}

                echo "Waiting for rollout..."
                kubectl rollout status deployment/kaniko-app \
                  -n ${NAMESPACE} --timeout=300s
                """
            }
        }

        stage('Cleanup Kaniko Job') {
            steps {
                sh """
                echo "Cleaning up Kaniko job..."
                kubectl delete job ${JOB_NAME} -n ${NAMESPACE} --ignore-not-found=true
                """
            }
        }
    }
}
