pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "roshaan1103/kaniko-test"
        DOCKER_TAG = "${BUILD_NUMBER}"
        NAMESPACE = "jenkins"
        JOB_NAME = "kaniko-${BUILD_NUMBER}"
    }

    stages {

        stage('Build & Push Image with Kaniko Job') {
            steps {
                sh """
                echo "Creating Kaniko Job with DockerHub secret..."

                cat <<EOF | kubectl apply -f -
apiVersion: batch/v1
kind: Job
metadata:
  name: ${JOB_NAME}
  namespace: ${NAMESPACE}
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: kaniko
        image: gcr.io/kaniko-project/executor:latest
        args:
        - "--dockerfile=jenkins/Dockerfile"
        - "--context=git://github.com/roshaan1103/kaniko-test.git"
        - "--destination=${DOCKER_IMAGE}:${DOCKER_TAG}"
        volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
      volumes:
      - name: docker-config
        secret:
          secretName: dockerhub-secret
          items:
          - key: .dockerconfigjson
            path: config.json
EOF

                echo "Waiting for Kaniko job to complete..."
                kubectl wait --for=condition=complete job/${JOB_NAME} \
                  -n ${NAMESPACE} --timeout=600s

                echo "Printing Kaniko logs..."
                kubectl logs job/${JOB_NAME} -n ${NAMESPACE}
                """
            }
        }

        stage('Deploy to Kubernetes with Helm') {
            steps {
                sh """
                echo "Deploying with Helm..."

                helm upgrade --install kaniko-app ./kaniko-app \
                  --namespace ${NAMESPACE} \
                  --set image.tag=${DOCKER_TAG}

                echo "Waiting for rollout..."
                kubectl rollout status deployment/kaniko-app \
                  -n ${NAMESPACE} --timeout=300s
                """
            }
        }

        stage('Cleanup Kaniko Job') {
            steps {
                sh """
                echo "Cleaning up Kaniko Job..."
                kubectl delete job ${JOB_NAME} -n ${NAMESPACE} --ignore-not-found=true
                """
            }
        }
    }
}
